<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cotells — Digitalt Samtidsbarometer</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <header class="nav">
    <div class="container">
      <a class="brand" href="/">
        <img src="/logo.svg" alt="Cotells logo" width="28" height="28" />
        <span class="brand-name">Cotells</span>
      </a>
      <nav>
        <a href="/admin/" class="cta-link">Admin</a>
      </nav>
    </div>
  </header>

  <section class="hero">
    <div class="container hero-inner">
      <div class="hero-copy">
        <h1>Digitalt Samtidsbarometer</h1>
        <p>Cotells kuraterer nyheter og viser sanntidsstemning.</p>
        <form class="signup" id="signup-form">
          <input type="email" id="email" placeholder="E-post for tidlig tilgang" required />
          <button type="submit">Få tilgang</button>
        </form>
      </div>

      <div class="hero-art">
        <div class="card">
          <h3>Dagens tema</h3>
          <p id="topic">Laster…</p>
          <div class="meter"><div class="meter-fill" id="sentiment" style="width:50%"></div></div>
          <div class="labels"><span>Negativ</span><span>Nøytral</span><span>Positiv</span></div>
          <div class="poll">
            <p class="question" id="question">Laster…</p>
            <div class="options" id="options"></div>
            <p id="vote-msg" class="small" style="display:none;"></p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="container" style="margin-top:18px;">
    <h3 style="color:#e2e8f0;margin:0 0 10px;">Flere tema i dag</h3>
    <div id="topic-grid" class="grid"></div>
  </section>

  <footer class="footer">
    <div class="container">
      <span>© <span id="year"></span> Cotells</span>
      <a href="/admin/">Admin</a>
    </div>
  </footer>

  <script>
    document.getElementById("year").textContent = new Date().getFullYear();
    document.getElementById("signup-form").addEventListener("submit", (e) => {
      e.preventDefault();
      const email = document.getElementById("email").value;
      alert("Takk! Vi lagrer " + email + " for tidlig tilgang.");
    });
    function widthFromSentiment(s){ return Math.max(0, Math.min(100, Math.round((Number(s||0)+1)*50))); }
    async function loadTopics(){
      const r = await fetch('/api/topics'); const j = await r.json(); const list = j.topics || []; if(!list.length) return;
      const t = list[0];
      document.getElementById('topic').textContent = t.title || '—';
      document.getElementById('question').textContent = t.question || 'Hva mener du?';
      document.getElementById('sentiment').style.width = widthFromSentiment(t.sentiment) + '%';
      const options = document.getElementById('options'); const msg = document.getElementById('vote-msg'); options.innerHTML = '';
      ['Ja','Nei','Usikker'].forEach(c => {
        const b = document.createElement('button'); b.className='option'; b.textContent=c;
        b.onclick = async () => {
          const r2 = await fetch('/api/vote',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({question_id:t.id,choice:c})});
          msg.style.display='block'; msg.textContent = r2.ok ? 'Takk for stemmen!' : 'Kunne ikke lagre stemme.';
        };
        options.appendChild(b);
      });
      const grid = document.getElementById('topic-grid'); grid.innerHTML='';
      list.slice(1,7).forEach(x => {
        const el = document.createElement('div'); el.className='card';
        el.innerHTML = `
          <h4 style="margin:0 0 6px;">${x.title || '—'}</h4>
          <div class="meter"><div class="meter-fill" style="width:${widthFromSentiment(x.sentiment)}%"></div></div>
          <div class="labels"><span>Negativ</span><span>Nøytral</span><span>Positiv</span></div>
          <p class="small" style="margin-top:6px;color:#94a3b8">Ja: ${x.votes?.Ja||0} · Nei: ${x.votes?.Nei||0} · Usikker: ${x.votes?.Usikker||0}</p>
          ${x.url ? `<a href="${x.url}" target="_blank" rel="noopener" style="color:#7dd3fc">Kilde: ${x.source||'lenke'}</a>` : ''}
        `;
        grid.appendChild(el);
      });
    }
    loadTopics();
  </script>
</body>
</html>
