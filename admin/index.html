
<!DOCTYPE html><html lang="no"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Cotells · Admin</title><link rel="stylesheet" href="/styles.css"/>
<style>
  .admin-wrap{max-width:1000px;margin:40px auto;background:rgba(2,6,23,.6);border:1px solid rgba(125,211,252,.2);border-radius:16px;padding:20px}
  table, th, td { color:#e2e8f0 !important; }
  input,button{padding:10px 12px;border-radius:10px;border:1px solid rgba(125,211,252,.25);background:#0b1020;color:#e2e8f0}
  button{background:#22d3ee;border:0;color:#001018;font-weight:700;cursor:pointer}
  a{ color:#7dd3fc; } table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border-bottom:1px solid rgba(125,211,252,.15);padding:10px}.badge{background:#22d3ee;color:#001018;padding:3px 8px;border-radius:999px;font-weight:800;font-size:12px}
  .row{display:flex;gap:12px;align-items:center}
  .pill{border:1px solid rgba(125,211,252,.35);padding:6px 10px;border-radius:999px}
  .list{display:flex;flex-wrap:wrap;gap:8px;margin:6px 0}
</style></head><body>
<div class="admin-wrap">
  <h2>Cotells – Admin</h2>
  <div class="row">
    <input id="token" placeholder="ADMIN_TOKEN" style="min-width:260px"/>
    <button id="save">Lagre token</button>
    <button id="fetch">Kjør fetch nå</button>
    <a href="/" style="margin-left:auto;">Til forsiden</a>
  </div>

  <h3 style="margin-top:16px;">Aktive (rekkefølge brukes på forsiden, maks 10)</h3>
  <div id="active" class="list"></div>
  <div class="row">
    <button id="saveActive">Lagre rekkefølge</button>
    <span id="msg" style="color:#93c5fd"></span>
  </div>

  <h3 style="margin-top:16px;">Alle tema</h3>
  <table id="tbl">
    <thead><tr><th>#</th><th>Tittel</th><th>Kilde</th><th>Publisert</th><th>Stemmer</th><th>Legg til</th></tr></thead>
    <tbody></tbody>
  </table>
</div>
<script>
const $=s=>document.querySelector(s);
$('#token').value=localStorage.getItem('ADMIN_TOKEN')||'cotells_admin_2025';

function pill(id,title){
  const div=document.createElement('span'); div.className='pill'; div.textContent=title; div.dataset.id=id;
  div.title='Dra for å endre rekkefølge. Klikk for å fjerne.';
  div.onclick=()=>{ div.remove(); };
  div.draggable=true;
  div.ondragstart=(e)=>{ e.dataTransfer.setData('text/plain', id); };
  return div;
}
function loadActive(list, activeIds){
  const box = $('#active'); box.innerHTML='';
  activeIds.forEach(id=>{
    const t = list.find(x=>x.id===id);
    if(t) box.appendChild(pill(id, t.title));
  });
}
function getActiveIds(){
  return Array.from(document.querySelectorAll('#active .pill')).map(x=>x.dataset.id).slice(0,10);
}

async function api(p,o={}){
  const h=o.headers||{}; h['Authorization']='Bearer '+($('#token').value||''); h['Content-Type']='application/json';
  const r=await fetch(p,{...o,headers:h}); const j=await r.json().catch(()=>({})); if(!r.ok) throw new Error(j.error||'Feil'); return j;
}

let LIST=[];
async function load(){
  const j=await api('/api/admin/topics'); LIST = j.topics || [];
  // table
  const tb=document.querySelector('#tbl tbody'); tb.innerHTML='';
  LIST.forEach((t,i)=>{
    const v=t.votes||{Ja:0,Nei:0,Usikker:0,total:0};
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${t.title||'-'}</td><td>${t.source||'-'}</td>
    <td>${t.published_at?new Date(t.published_at).toLocaleString():'-'}</td>
    <td>Ja: ${v.Ja} · Nei: ${v.Nei} · Usikker: ${v.Usikker} · Sum: ${v.total}</td>
    <td><button class="add" data-id="${t.id}">Legg til</button></td>`;
    tb.appendChild(tr);
  });
  loadActive(LIST, j.active||[]);
}
document.addEventListener('click', (ev)=>{
  if(ev.target.classList.contains('add')){
    const id=ev.target.getAttribute('data-id');
    const t=LIST.find(x=>x.id===id);
    if(!t) return;
    if(getActiveIds().includes(id)) return;
    if(getActiveIds().length>=10){ $('#msg').textContent='Maks 10 aktive.'; return; }
    $('#active').appendChild(pill(id, t.title));
  }
});

$('#save').onclick=()=>{ localStorage.setItem('ADMIN_TOKEN',$('#token').value||''); $('#msg').textContent='Token lagret.'; };
$('#fetch').onclick=async()=>{ $('#msg').textContent='Henter…'; try{ const j=await api('/api/admin/fetch-now',{method:'POST'}); $('#msg').textContent='Fetch ok.'; await load(); }catch(e){ $('#msg').textContent=e.message; } };
$('#saveActive').onclick=async()=>{
  try{ const ids=getActiveIds(); const j=await api('/api/admin/set-active',{method:'POST', body: JSON.stringify({ids})}); $('#msg').textContent='Lagret rekkefølge ('+j.active.length+').'; }
  catch(e){ $('#msg').textContent=e.message; }
};

// drag over active box
$('#active').ondragover = (e)=>{ e.preventDefault(); };
$('#active').ondrop = (e)=>{ e.preventDefault(); const id=e.dataTransfer.getData('text/plain'); const t=LIST.find(x=>x.id===id); if(!t) return; if(getActiveIds().includes(id)) return; if(getActiveIds().length>=10){ $('#msg').textContent='Maks 10 aktive.'; return; } $('#active').appendChild(pill(id, t.title)); };

load();
</script>
</body></html>
