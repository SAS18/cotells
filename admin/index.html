
<!DOCTYPE html><html lang="no"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Cotells · Admin</title>
<link rel="stylesheet" href="/styles.css"/>
<style>
  .admin-wrap{max-width:980px;margin:40px auto;background:rgba(2,6,23,.6);border:1px solid rgba(125,211,252,.2);border-radius:16px;padding:20px}
  input,button{padding:10px 12px;border-radius:10px;border:1px solid rgba(125,211,252,.25);background:#0b1020;color:#e2e8f0}
  button{background:#22d3ee;border:0;color:#001018;font-weight:700;cursor:pointer}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border-bottom:1px solid rgba(125,211,252,.15);padding:10px}
  .badge{background:#22d3ee;color:#001018;padding:3px 8px;border-radius:999px;font-weight:800;font-size:12px}
</style>
</head><body>
<div class="admin-wrap">
  <h2>Cotells – Admin</h2>
  <div style="display:flex;gap:8px;flex-wrap:wrap;">
    <input id="token" placeholder="ADMIN_TOKEN"/>
    <button id="save">Lagre token</button>
    <button id="fetch">Kjør fetch nå</button>
    <a href="/" style="margin-left:auto;color:#7dd3fc">Til forsiden</a>
  </div>
  <div id="msg" style="margin:8px 0;color:#93c5fd"></div>
  <table id="tbl">
    <thead><tr><th>#</th><th>Tittel</th><th>Kilde</th><th>Publisert</th><th>Stemmer</th><th>Handling</th></tr></thead>
    <tbody></tbody>
  </table>
</div>
<script>
const $=s=>document.querySelector(s);
$('#token').value=localStorage.getItem('ADMIN_TOKEN')||'cotells_admin_2025';
async function api(p,o={}){
  const h=o.headers||{}; h['Authorization']='Bearer '+($('#token').value||''); h['Content-Type']='application/json';
  const r=await fetch(p,{...o,headers:h}); const j=await r.json().catch(()=>({})); if(!r.ok) throw new Error(j.error||'Feil'); return j;
}
async function load(){
  try{
    const j=await api('/api/admin/topics');
    const tb=document.querySelector('#tbl tbody'); tb.innerHTML='';
    j.topics.forEach((t,i)=>{
      const v=t.votes||{Ja:0,Nei:0,Usikker:0,total:0};
      const badge=(j.featured===t.id)?'<span class="badge">Dagens</span>':(i+1);
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${badge}</td><td>${t.title||'-'}</td><td>${t.source||'-'}</td>
        <td>${t.published_at?new Date(t.published_at).toLocaleString():'-'}</td>
        <td>Ja: ${v.Ja} · Nei: ${v.Nei} · Usikker: ${v.Usikker} · Sum: ${v.total}</td>
        <td><button data-id="${t.id}" class="set">Sett som dagens</button>
            <button data-id="${t.id}" class="reset">Nullstill</button></td>`;
      tb.appendChild(tr);
    });
  }catch(e){ document.getElementById('msg').textContent=e.message; }
}
document.getElementById('save').onclick=()=>{ localStorage.setItem('ADMIN_TOKEN', document.getElementById('token').value || ''); document.getElementById('msg').textContent='Token lagret.'; }
document.getElementById('fetch').onclick=async()=>{
  document.getElementById('msg').textContent='Henter…';
  try{ const j=await api('/api/admin/fetch-now',{method:'POST'});
       document.getElementById('msg').textContent='Fetch ok: '+(j.result?.topics||0)+' tema.'; await load();
  }catch(e){ document.getElementById('msg').textContent='Feil: '+e.message; }
}
document.addEventListener('click', async ev => {
  if(ev.target.classList.contains('set')){
    const id=ev.target.getAttribute('data-id');
    try{ await api('/api/admin/set-featured',{method:'POST', body: JSON.stringify({id})});
         document.getElementById('msg').textContent='Satt som dagens.'; await load();
    }catch(e){ document.getElementById('msg').textContent=e.message; }
  }
  if(ev.target.classList.contains('reset')){
    const id=ev.target.getAttribute('data-id');
    try{ await api('/api/admin/reset-votes',{method:'POST', body: JSON.stringify({id})});
         document.getElementById('msg').textContent='Stemmer nullstilt.';
    }catch(e){ document.getElementById('msg').textContent=e.message; }
  }
});
load();
</script>
</body></html>
